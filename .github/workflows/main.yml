name: Buddy e2e Testing

on:
  pull_request:
    branches: [master]
  push:
    branches: [feature/ci-testing-1]
  workflow_dispatch:

jobs:
  test_pull_request:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v2
        with:
          node-version: '14'
      - uses: actions/setup-python@v2
        with:
          python-version: '3.7'
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.GIT_SSH_KEY }}
          name: id_rsa # optional
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          config: ${{ secrets.SSH_CONFIG }} # ssh_config; optional
          if_key_exists: replace # replace / ignore / fail; optional (defaults to fail)
      - run: |
          set -e
          set -x
          
          export GIT_MAIL=${{ secrets.GIT_MAIL }}
          export GIT_NAME=${{ secrets.GIT_NAME }}
          export TERM=xterm
          export WANDB_API_KEY=${{ secrets.WANDB_API_KEY }}
          
          git config --global user.email "$GIT_MAIL"
          git config --global user.name "$GIT_NAME"
          
          pip install -q virtualenv

          git clone git@github.com:ministry-of-silly-code/examples.git
          cd examples

          export BUDDY_CURRENT_TESTING_BRANCH=${GITHUB_REF#refs/heads/}
          sed -i -e "s|\.git.*\#egg|\.git\@$BUDDY_CURRENT_TESTING_BRANCH\#egg|" requirements.txt

          virtualenv buddy_env
          source ./buddy_env/bin/activate
          pip install -q -r ./requirements.txt
          DEPLOY_DESTINATION=local python ./mnist_classifier.py
          DEPLOY_DESTINATION=cluster python ./mnist_classifier.py